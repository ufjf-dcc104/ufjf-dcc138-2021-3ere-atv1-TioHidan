<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC138 exemplo 01</title>
</head>
<body>
    <h1>DCC138 exemplo 01</h1>
    <canvas></canvas>
    <p>Por Victor Torres</p>
    <script>
        let canvas = document.querySelector("canvas");
        
        let ctx = canvas.getContext("2d");
        
         canvas.width = 480;
         canvas.height = 320;

         let pontos= 0;
         let p={
          x: 150,
          vx :0,
          ax : 0,
          y : 100,
          vy : 0,
          ay : 0,
          w: 40,
          h: 15,
          cor:"Red",
           desenhar: desenharElemento,
        
            mover: moverElemento

       
          };
         const sprites = [];
         for (let ne = 0; ne < 20; ne++) {
           
          let e= {
          x : canvas.width * (1+10*Math.random()),
          vx : -20,
          ax : 0,
          y  : canvas.height * Math.random(),
          vy : 0,
          ay : 0,
          w: 15,
          h: 15,
          cor: "White",
          desenhar: desenharElemento,
          mover: moverElemento,
         controlar: perseguirAlvo
          };
          sprites.push(e);
        }

        let o={
          x: -1000,
          vx :0,
          ax : 0,
          y : 150,
          vy : 0,
          ay : 0,
          w: 5,
          h: 5,
          cor:"Blue",
           desenhar: desenharElemento,
        
            mover: moverElemento,
            controlar: function (params) {
               if(this.x> canvas.width +60) {
                   this.x= -1000;
                   this.ax=0;
                   this.vx=0;
               }
            }
            
         };
         sprites.push(o);
        
        //refatora para extrair constante de velocidade
         const V = 180;
         let t0;
         let dt; 
         requestAnimationFrame(desenha);
         
         function desenha(t){

        if(t0===undefined) t0 = t;
        dt = (t - t0)/1000;
        
        //desenha fundo
         
        ctx.fillStyle = "black";
         ctx.fillRect(0,0,  canvas.width,canvas.height);
          
         
         p.mover();
        

         for (let s = 0; s < sprites.length; s++) {
             const sprite = sprites[s];
             
   
         //controladores
          sprite.controlar?.(p);
         
        
        //Atualiza Dinamica dos estados
           
           sprite.mover();
       
         //desenha elementos
           
         
           sprite.desenhar();

           if(colidiram(o,sprite) && o!= sprite){
            
            o.x=-1000;
            o.y=-1000;
            o.vx=0;
            o.ax=0;
            sprite.x=1000;
            sprite.vx=100;
            sprite.ax=0;
            pontos++;
           }
           if(colidiram(p,sprite) && o!= sprite){
            
            
            sprite.x=1000;
            sprite.vx=100;
            sprite.ax=0;
            pontos-=3;
           }
         }
         p.desenhar();
         ctx.fillStyle="yellow";
         ctx.font="20px impact"
         ctx.fillText(pontos,10,30);
         
         
         //chama a função desenha infinitas vezes
         requestAnimationFrame(desenha);
         t0 = t;
         }
        
        
         function moverElemento(){
        this.vx= this.vx + this.ax*dt;
        this.x = this.x + this.vx*dt;
        this.vy= this.vy + this.ay*dt;
        this.y = this.y + this.vy*dt;
         }
         
         // desenhar elemento
         function desenharElemento(){
           
           ctx.fillStyle = this.cor;
           ctx.fillRect(this.x,this.y,this.w,this.h);
         }

         function perseguirAlvo(alvo){
            
            this.ay= 100*Math.sign(alvo.y - this.y) - 0.2*this.vx;
            this.ax= 100*Math.sign(alvo.x - this.x) - 0.2*this.vy;
         }

         function evitarAlvo(alvo){
            
            this.ay= -0.5*(alvo.y - this.y) - 0.2*this.vx;
            this.ax= -0.5*(alvo.x - this.x) - 0.2*this.vy;
         }
        
       
       
         // evento pra quando vc quer que o boneco se mova infinito
         addEventListener("keydown" , teclapressionada);
         
         
         
         // evento para quando voce soltar o dedo do botao o personagem parar
         addEventListener("keyup" , teclasolta);


        
        
        //adiciona controle de velocidades
         function teclapressionada(e){
          
           switch (e.key){
               
                  case "ArrowUp":
                   p.ay=-V;
                   break;
                
                   case "ArrowDown":
                   p.ay= +V;
                   break;

                   case "ArrowRight":
                   p.ax=+V;
                   break;
                
                   case "ArrowLeft":
                   p.ax= -V;
                   break;

                 

           }

           
         }
         //adiciona controle de velocidades sem manter pressionado
         function teclasolta(e) {
          
           switch (e.key){
               
                  case "ArrowUp":
                   
                   p.ay=0;
                   break;
                
                   case "ArrowDown":
                   
                   p.ay= 0;
                   break;

                   case "ArrowRight":
                   
                   p.ax=0;
                   break;
                
                   case "ArrowLeft":
                   
                   p.ax=0;
                   break;

                   case " ":
                   if(o.x=== -1000){
                   o.x=p.x;
                   o.y=p.y;
                   o.vx=200;
                   o.ax=100;
                   
                   }
                   
                   break;

                   

           }
        }
        function colidiram(A,B) {
          return  !(
                (A.x > B.x + B.w)
              ||(A.x +A.w < B.x )
              ||(A.y > B.y + B.h)
              ||(A.y +A.h < B.y )
              );
        }

        

    </script>
    
</body>
</html>